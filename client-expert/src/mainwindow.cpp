#include "mainwindow.h"
#include "loginregisterdialog.h"
#include "modernstyle.h"
#include <QCameraInfo>
#include <QBuffer>
#include <QCameraViewfinderSettings>
#include <QVideoFrame>
#include <QVideoProbe>
#include <QDebug>
#include <QJsonDocument>
#include <QJsonObject>
#include <QDateTime>
#include <QVBoxLayout>
#include <QHBoxLayout>
#include <QLineEdit>
#include <QPushButton>
#include <QLabel>
#include <QTextEdit>
#include <QPixmap>
#include <QCheckBox>
#include <QMessageBox>
#include <QListWidget>
#include <QDockWidget>
#include <QSplitter>
#include <QGridLayout>
#include <QTreeWidget>
#include <QMenuBar>
#include <QStatusBar>
#include <QTabWidget>
#include <QGroupBox>

// ÂÅáËÆæËøô‰∫õÂÆèÂíåÁ±ªÂú®ÂÖ∂‰ªñÂú∞ÊñπÂÆö‰πâ
// #define MSG_JOIN_WORKORDER 100
// #define MSG_TEXT 101
// #define MSG_VIDEO_FRAME 102
// class Packet { ... };
// class ClientConn { ... };

MainWindow::MainWindow(QWidget *parent)
    : QMainWindow(parent)
    , currentUserRole_(UserRole::None)
    , camera_(nullptr)
    , probe_(nullptr)
    , settings_("irexp", "client-expert")
    , isConnected_(false)
    , isJoinedRoom_(false)
    , isAuthenticated_(false)
{
    // Apply modern dark theme
    setStyleSheet(ModernStyle::getDarkThemeStyleSheet());
    
    // Set window properties
    setWindowTitle("ÊäÄÊúØ‰∏ìÂÆ∂ÂÆ¢Êà∑Á´Ø - Industrial Remote Expert");
    setMinimumSize(1200, 800);
    resize(1400, 900);
    
    // Create menu bar
    createMenuBar();
    
    // Create status bar
    statusBar()->showMessage("Êú™ËøûÊé•Âà∞ÊúçÂä°Âô®");
    
    // Show login dialog first
    showLoginDialog();
}

void MainWindow::showLoginDialog()
{
    LoginRegisterDialog* loginDialog = new LoginRegisterDialog(this);
    
    connect(loginDialog, &LoginRegisterDialog::loginRequested, 
            this, &MainWindow::onLoginSuccess);
    connect(loginDialog, &LoginRegisterDialog::registerRequested, 
            this, &MainWindow::onRegisterSuccess);
    
    if (loginDialog->exec() == QDialog::Accepted) {
        currentUserRole_ = loginDialog->getSelectedRole();
        authenticatedUsername_ = loginDialog->getUsername();
        
        if (currentUserRole_ == UserRole::Expert) {
            setupExpertMainUI();
            statusBar()->showMessage(QString("Â∑≤ÁôªÂΩïÁî®Êà∑: %1 (ÊäÄÊúØ‰∏ìÂÆ∂)").arg(authenticatedUsername_));
        } else {
            QMessageBox::warning(this, "ËßíËâ≤ÈîôËØØ", "ÊäÄÊúØ‰∏ìÂÆ∂ÂÆ¢Êà∑Á´ØÂè™ËÉΩ‰ΩøÁî®ÊäÄÊúØ‰∏ìÂÆ∂Ë∫´‰ªΩÁôªÂΩïÔºÅ");
            QApplication::quit();
        }
    } else {
        QApplication::quit();
    }
    
    loginDialog->deleteLater();
}

void MainWindow::setupExpertMainUI()
{
    // Create central widget with video grid
    createVideoGrid();
    
    // Create dockable panels
    createNavigationPanel();
    createParticipantPanel(); 
    createChatPanel();
    
    // Set up connections
    connect(&conn_, &ClientConn::packetArrived, this, &MainWindow::onPkt);
    connect(&conn_, &ClientConn::connected, this, &MainWindow::onConnected);
    connect(&conn_, &ClientConn::disconnected, this, &MainWindow::onDisconnected);
}

void MainWindow::createMenuBar()
{
    auto* fileMenu = menuBar()->addMenu("Êñá‰ª∂(&F)");
    fileMenu->addAction("ËøûÊé•ÊúçÂä°Âô®(&C)", this, &MainWindow::onConnect, QKeySequence("Ctrl+C"));
    fileMenu->addSeparator();
    fileMenu->addAction("ÈÄÄÂá∫(&X)", this, &QWidget::close, QKeySequence("Ctrl+Q"));
    
    auto* workOrderMenu = menuBar()->addMenu("Â∑•Âçï(&W)");
    workOrderMenu->addAction("Âä†ÂÖ•Â∑•Âçï(&J)", this, &MainWindow::onJoin, QKeySequence("Ctrl+J"));
    workOrderMenu->addAction("Á¶ªÂºÄÂ∑•Âçï(&L)", [this]() {
        // TODO: Implement leave work order
    });
    
    auto* videoMenu = menuBar()->addMenu("ËßÜÈ¢ë(&V)");
    videoMenu->addAction("ÂºÄÂêØ/ÂÖ≥Èó≠ÊëÑÂÉèÂ§¥(&T)", this, &MainWindow::onToggleCamera, QKeySequence("Ctrl+T"));
    
    auto* helpMenu = menuBar()->addMenu("Â∏ÆÂä©(&H)");
    helpMenu->addAction("ÂÖ≥‰∫é(&A)", [this]() {
        QMessageBox::about(this, "ÂÖ≥‰∫é", "Industrial Remote Expert\nÊäÄÊúØ‰∏ìÂÆ∂ÂÆ¢Êà∑Á´Ø v1.0");
    });
}

void MainWindow::createNavigationPanel()
{
    navigationDock_ = new QDockWidget("ÂØºËà™", this);
    navigationDock_->setFeatures(QDockWidget::DockWidgetMovable | QDockWidget::DockWidgetFloatable);
    
    auto* navWidget = new QWidget();
    auto* navLayout = new QVBoxLayout(navWidget);
    
    // Connection controls
    auto* connectionGroup = new QGroupBox("ÊúçÂä°Âô®ËøûÊé•");
    auto* connLayout = new QFormLayout(connectionGroup);
    
    edHost = new QLineEdit("127.0.0.1");
    edPort = new QLineEdit("9000");
    edPort->setMaximumWidth(80);
    auto* btnConn = new QPushButton("ËøûÊé•");
    
    connLayout->addRow("‰∏ªÊú∫:", edHost);
    connLayout->addRow("Á´ØÂè£:", edPort);
    connLayout->addRow("", btnConn);
    navLayout->addWidget(connectionGroup);
    
    // Work orders
    auto* workOrderGroup = new QGroupBox("Â∑•ÂçïÂàóË°®");
    auto* woLayout = new QVBoxLayout(workOrderGroup);
    
    workOrderList_ = new QTreeWidget();
    workOrderList_->setHeaderLabels({"Â∑•Âçï", "Áä∂ÊÄÅ", "ÂàõÂª∫Êó∂Èó¥"});
    woLayout->addWidget(workOrderList_);
    
    auto* joinLayout = new QHBoxLayout();
    edRoom = new QLineEdit("R123");
    edRoom->setPlaceholderText("ËæìÂÖ•Â∑•ÂçïÂè∑");
    edUser = new QLineEdit(authenticatedUsername_);
    edUser->setVisible(false); // Hidden in modern UI, using authenticated username
    joinButton_ = new QPushButton("Âä†ÂÖ•Â∑•Âçï");
    joinButton_->setEnabled(false);
    
    joinLayout->addWidget(edRoom);
    joinLayout->addWidget(joinButton_);
    woLayout->addLayout(joinLayout);
    
    navLayout->addWidget(workOrderGroup);
    
    // Device data section
    auto* deviceGroup = new QGroupBox("ËÆæÂ§áÊï∞ÊçÆ");
    auto* deviceLayout = new QVBoxLayout(deviceGroup);
    
    auto* deviceList = new QListWidget();
    deviceList->addItem("Ê∏©Â∫¶‰º†ÊÑüÂô® - Ê≠£Â∏∏");
    deviceList->addItem("ÂéãÂäõ‰º†ÊÑüÂô® - Ê≠£Â∏∏");  
    deviceList->addItem("ÊµÅÈáèËÆ° - Ë≠¶Âëä");
    deviceLayout->addWidget(deviceList);
    
    navLayout->addWidget(deviceGroup);
    
    navLayout->addStretch();
    
    navigationDock_->setWidget(navWidget);
    addDockWidget(Qt::LeftDockWidgetArea, navigationDock_);
    
    // Connect signals
    connect(btnConn, &QPushButton::clicked, this, &MainWindow::onConnect);
    connect(joinButton_, &QPushButton::clicked, this, &MainWindow::onJoin);
}

void MainWindow::createVideoGrid()
{
    videoGrid_ = new QWidget();
    auto* gridLayout = new QGridLayout(videoGrid_);
    
    // Create video display areas for up to 6 participants
    for (int i = 0; i < 6; ++i) {
        auto* videoFrame = new QLabel();
        videoFrame->setMinimumSize(320, 240);
        videoFrame->setStyleSheet(R"(
            QLabel {
                border: 2px solid #555555;
                border-radius: 8px;
                background-color: #404040;
                color: #ffffff;
            }
        )");
        videoFrame->setAlignment(Qt::AlignCenter);
        videoFrame->setText(i == 0 ? "Êú¨Âú∞ËßÜÈ¢ë\n(Êú™ÂºÄÂêØ)" : QString("ÂèÇ‰∏éËÄÖ %1\n(Êú™ËøûÊé•)").arg(i));
        videoFrame->setScaledContents(true);
        
        gridLayout->addWidget(videoFrame, i / 3, i % 3);
        
        if (i == 0) {
            videoLabel_ = videoFrame; // Keep reference to local video
        } else if (i == 1) {
            remoteLabel_ = videoFrame; // Keep reference for compatibility
        }
    }
    
    setCentralWidget(videoGrid_);
}

void MainWindow::createParticipantPanel()
{
    participantDock_ = new QDockWidget("ÂèÇ‰∏éËÄÖ", this);
    participantDock_->setFeatures(QDockWidget::DockWidgetMovable | QDockWidget::DockWidgetFloatable);
    
    auto* participantWidget = new QWidget();
    auto* participantLayout = new QVBoxLayout(participantWidget);
    
    auto* participantLabel = new QLabel("Âú®Á∫øÂèÇ‰∏éËÄÖ:");
    participantLabel->setProperty("class", "heading");
    participantLayout->addWidget(participantLabel);
    
    participantList_ = new QListWidget();
    participantList_->addItem("üé• " + authenticatedUsername_ + " (‰Ω†)");
    participantLayout->addWidget(participantList_);
    
    // Control buttons
    auto* controlGroup = new QGroupBox("ÊéßÂà∂");
    auto* controlLayout = new QVBoxLayout(controlGroup);
    
    btnCamera_ = new QPushButton("ÂºÄÂêØÊëÑÂÉèÂ§¥");
    auto* btnMute = new QPushButton("ÈùôÈü≥");
    auto* btnRecord = new QPushButton("ÂºÄÂßãÂΩïÂà∂");
    
    controlLayout->addWidget(btnCamera_);
    controlLayout->addWidget(btnMute);
    controlLayout->addWidget(btnRecord);
    
    chkAutoStart_ = new QCheckBox("Ëá™Âä®ÂºÄÂêØÊëÑÂÉèÂ§¥");
    chkAutoStart_->setChecked(loadAutoStartPreference());
    controlLayout->addWidget(chkAutoStart_);
    
    participantLayout->addWidget(controlGroup);
    participantLayout->addStretch();
    
    participantDock_->setWidget(participantWidget);
    addDockWidget(Qt::RightDockWidgetArea, participantDock_);
    
    // Connect signals
    connect(btnCamera_, &QPushButton::clicked, this, &MainWindow::onToggleCamera);
    connect(chkAutoStart_, &QCheckBox::toggled, this, &MainWindow::onAutoStartToggled);
}

void MainWindow::createChatPanel()
{
    chatDock_ = new QDockWidget("ËÅäÂ§©", this);
    chatDock_->setFeatures(QDockWidget::DockWidgetMovable | QDockWidget::DockWidgetFloatable);
    
    auto* chatWidget = new QWidget();
    auto* chatLayout = new QVBoxLayout(chatWidget);
    
    // Chat tabs for different conversations
    chatTabs_ = new QTabWidget();
    
    // Main chat tab
    auto* mainChatTab = new QWidget();
    auto* mainChatLayout = new QVBoxLayout(mainChatTab);
    
    chatDisplay_ = new QTextEdit();
    chatDisplay_->setReadOnly(true);
    chatDisplay_->append("Á≥ªÁªü: Ê¨¢Ëøé‰ΩøÁî®ÊäÄÊúØ‰∏ìÂÆ∂ÂÆ¢Êà∑Á´Ø");
    txtLog = chatDisplay_; // Keep reference for compatibility
    
    chatInput_ = new QLineEdit();
    chatInput_->setPlaceholderText("ËæìÂÖ•Ê∂àÊÅØ...");
    edInput = chatInput_; // Keep reference for compatibility
    
    auto* sendButton = new QPushButton("ÂèëÈÄÅ");
    auto* inputLayout = new QHBoxLayout();
    inputLayout->addWidget(chatInput_);
    inputLayout->addWidget(sendButton);
    
    mainChatLayout->addWidget(chatDisplay_);
    mainChatLayout->addLayout(inputLayout);
    
    chatTabs_->addTab(mainChatTab, "‰∏ªËÅäÂ§©");
    chatLayout->addWidget(chatTabs_);
    
    chatDock_->setWidget(chatWidget);
    addDockWidget(Qt::BottomDockWidgetArea, chatDock_);
    
    // Connect signals
    connect(sendButton, &QPushButton::clicked, this, &MainWindow::onSendText);
    connect(chatInput_, &QLineEdit::returnPressed, this, &MainWindow::onSendText);
    
    // Auto-start camera if enabled
    tryAutoStartCamera();
}

/* ---------- ÁΩëÁªú ---------- */
void MainWindow::onConnect()
{
    conn_.connectTo(edHost->text(), edPort->text().toUShort());
    txtLog->append("Connecting...");
}
void MainWindow::onJoin()
{
    QJsonObject j{{"roomId", edRoom->text()}, {"user", authenticatedUsername_}};
    conn_.send(MSG_JOIN_WORKORDER, j);
    currentRoom_ = edRoom->text();
    chatDisplay_->append(QString("Ê≠£Âú®Âä†ÂÖ•Â∑•Âçï: %1").arg(edRoom->text()));
}

void MainWindow::onSendText()
{
    if (edInput->text().trimmed().isEmpty()) return;
    
    QJsonObject j{{"roomId",  currentRoom_},
                  {"sender",  authenticatedUsername_},
                  {"content", edInput->text()},
                  {"ts",      QDateTime::currentMSecsSinceEpoch()}};
    
    chatDisplay_->append(QString("[Êàë] %1").arg(edInput->text()));
    conn_.send(MSG_TEXT, j);
    edInput->clear();
}
void MainWindow::onPkt(Packet p)
{
    switch (p.type)
    {
    case MSG_TEXT:
    {
        QString sender = p.json["sender"].toString();
        QString content = p.json["content"].toString();
        QString roomId = p.json["roomId"].toString();
        
        if (roomId == currentRoom_ && sender != authenticatedUsername_) {
            chatDisplay_->append(QString("[%1] %2").arg(sender, content));
        }
        break;
    }
    case MSG_VIDEO_FRAME:
    {
        QString sender = p.json["sender"].toString();
        QString roomId = p.json["roomId"].toString();
        
        // Only show video from other users in current room
        if (sender != authenticatedUsername_ && roomId == currentRoom_ && isJoinedRoom_) {
            QPixmap pix; 
            pix.loadFromData(p.bin);
            if (!pix.isNull()) {
                remoteLabel_->setPixmap(pix.scaled(remoteLabel_->size(), Qt::KeepAspectRatio));
            }
        }
        break;
    }
    case MSG_SERVER_EVENT:
    {
        chatDisplay_->append(QString("[ÊúçÂä°Âô®] %1")
                       .arg(QString::fromUtf8(QJsonDocument(p.json).toJson())));
        
        int code = p.json.value("code").toInt();
        QString message = p.json.value("message").toString();
        // Handle authentication responses
        if (code == 0 && message == "login successful") {
            isAuthenticated_ = true;
            sessionToken_ = p.json.value("token").toString();
            joinButton_->setEnabled(true);
            
            chatDisplay_->append("‚úÖ ÁôªÂΩïÊàêÂäüÔºÅÂèØ‰ª•Âä†ÂÖ•Â∑•Âçï‰∫Ü„ÄÇ");
            statusBar()->showMessage(QString("Â∑≤ËÆ§ËØÅÁî®Êà∑: %1").arg(authenticatedUsername_));
        }
        // Handle registration success
        else if (code == 0 && message == "registration successful") {
            chatDisplay_->append("‚úÖ Ê≥®ÂÜåÊàêÂäüÔºÅËØ∑ÈáçÊñ∞ÁôªÂΩï„ÄÇ");
        }
        // Handle room join success
        else if (code == 0 && message == "joined") {
            isJoinedRoom_ = true;
            chatDisplay_->append(QString("‚úÖ ÊàêÂäüÂä†ÂÖ•Â∑•Âçï: %1").arg(currentRoom_));
            statusBar()->showMessage(QString("Â∑≤Âä†ÂÖ•Â∑•Âçï: %1").arg(currentRoom_));
            
            // Update participant list
            participantList_->clear();
            participantList_->addItem("üé• " + authenticatedUsername_ + " (‰Ω†)");
            
            // Try auto-start camera
            tryAutoStartCamera();
        }
        // Handle error responses
        else if (code != 0) {
            if (message.contains("authentication required")) {
                chatDisplay_->append("‚ùå ÈîôËØØ: ËØ∑ÂÖàÁôªÂΩïÂÜçÂä†ÂÖ•Â∑•Âçï");
            } else if (message.contains("invalid username or password")) {
                chatDisplay_->append("‚ùå ÈîôËØØ: Áî®Êà∑ÂêçÊàñÂØÜÁ†ÅÈîôËØØ");
            } else if (message.contains("username already exists")) {
                chatDisplay_->append("‚ùå ÈîôËØØ: Áî®Êà∑ÂêçÂ∑≤Â≠òÂú®ÔºåËØ∑Â∞ùËØïÂÖ∂‰ªñÁî®Êà∑Âêç");
            } else {
                chatDisplay_->append(QString("‚ùå ÈîôËØØ: %1").arg(message));
            }
        }
        break;
    }
    }
}

/* ---------- ÊëÑÂÉèÂ§¥ ---------- */
void MainWindow::startCamera()
{
    if (camera_) return;

    const QList<QCameraInfo> cameras = QCameraInfo::availableCameras();
    if (cameras.isEmpty()) {
        txtLog->append("Ê≤°ÊúâÂèØÁî®ÊëÑÂÉèÂ§¥");
        QMessageBox::information(this, "Camera Not Found", 
            "No camera device found. Please:\n"
            "‚Ä¢ Install qtmultimedia and gstreamer packages\n"
            "‚Ä¢ If running in VM, pass through webcam device\n"
            "‚Ä¢ Check camera permissions");
        return;
    }

    camera_ = new QCamera(cameras.first(), this);   // ÂèñÁ¨¨‰∏Ä‰∏™Áâ©ÁêÜÊëÑÂÉèÂ§¥

    probe_ = new QVideoProbe(this);
    if (probe_->setSource(camera_)) {
        connect(probe_, &QVideoProbe::videoFrameProbed,
                this, &MainWindow::onVideoFrame);
        camera_->start(); // ÂêØÂä®ÊëÑÂÉèÂ§¥
    } else {
        txtLog->append("Êó†Ê≥ïËÆæÁΩÆÊé¢Â§¥ÊàñÂêØÂä®ÊëÑÂÉèÂ§¥");
        // Ê∏ÖÁêÜÂ∑≤ÂàõÂª∫ÁöÑÊëÑÂÉèÂ§¥ÂØπË±°
        camera_->deleteLater();
        camera_ = nullptr;
        probe_->deleteLater();
        probe_ = nullptr;
        return;
    }

    btnCamera_->setText("ÂÖ≥Èó≠ÊëÑÂÉèÂ§¥");
    txtLog->append("ÊëÑÂÉèÂ§¥Â∑≤ÂêØÂä®");
}

void MainWindow::stopCamera()
{
    if (!camera_) return;
    camera_->stop();
    // Á°Æ‰øùÂú®Âà†Èô§ QVideoProbe ‰πãÂâçÊñ≠ÂºÄËøûÊé•
    if (probe_) {
        disconnect(probe_, &QVideoProbe::videoFrameProbed,
                   this, &MainWindow::onVideoFrame);
        probe_->deleteLater();
        probe_ = nullptr;
    }
    camera_->deleteLater();
    camera_ = nullptr;

    videoLabel_->setText("Êú¨Âú∞ËßÜÈ¢ëÈ¢ÑËßà");
    btnCamera_->setText("ÂºÄÂêØÊëÑÂÉèÂ§¥");
    txtLog->append("ÊëÑÂÉèÂ§¥Â∑≤ÂÖ≥Èó≠");
}

void MainWindow::onToggleCamera()
{
    if (camera_) stopCamera();
    else         startCamera();
}

/* ---------- Â∏ßÈááÈõÜ + ÂèëÈÄÅ ---------- */
void MainWindow::onVideoFrame(const QVideoFrame &frame)
{
    if (!camera_ || !frame.isValid()) {
        return;
    }

    QVideoFrame clone(frame);

    if (!clone.map(QAbstractVideoBuffer::ReadOnly)) {
        txtLog->append("onVideoFrame: Êó†Ê≥ïÊò†Â∞ÑËßÜÈ¢ëÂ∏ßÊï∞ÊçÆ„ÄÇ");
        return;
    }

    QImage img;
    QVideoFrame::PixelFormat pixelFormat = clone.pixelFormat();

    qDebug() << "Video Frame Pixel Format:" << pixelFormat;
    txtLog->append(QString("Ê£ÄÊµãÂà∞ËßÜÈ¢ëÂ∏ßÂÉèÁ¥†Ê†ºÂºè: %1").arg(pixelFormat));


    if (pixelFormat == QVideoFrame::Format_ARGB32 ||
        pixelFormat == QVideoFrame::Format_ARGB32_Premultiplied) {
        img = QImage(clone.bits(), clone.width(), clone.height(),
                     clone.bytesPerLine(), QImage::Format_ARGB32);
    } else if (pixelFormat == QVideoFrame::Format_RGB32) {
        img = QImage(clone.bits(), clone.width(), clone.height(),
                     clone.bytesPerLine(), QImage::Format_RGB32);
    }
    // Â§ÑÁêÜ BGR32: Âä†ËΩΩ‰∏∫ RGB32ÔºåÁÑ∂Âêé‰∫§Êç¢ÈÄöÈÅì
    else if (pixelFormat == QVideoFrame::Format_BGR32) {
        img = QImage(clone.bits(), clone.width(), clone.height(),
                     clone.bytesPerLine(), QImage::Format_RGB32).rgbSwapped();
    }
    else if (pixelFormat == QVideoFrame::Format_RGB24) {
        img = QImage(clone.bits(), clone.width(), clone.height(),
                     clone.bytesPerLine(), QImage::Format_RGB888); // RGB888 ÂØπÂ∫î 24-bit RGB
    }
    // Â§ÑÁêÜ BGR24: Âä†ËΩΩ‰∏∫ RGB888ÔºåÁÑ∂Âêé‰∫§Êç¢ÈÄöÈÅì
    else if (pixelFormat == QVideoFrame::Format_BGR24) {
        img = QImage(clone.bits(), clone.width(), clone.height(),
                     clone.bytesPerLine(), QImage::Format_RGB888).rgbSwapped();
    }
    // **Ê†∏ÂøÉ‰øÆÊîπÔºöÂ§ÑÁêÜ YUYV Ê†ºÂºè**
    else if (pixelFormat == QVideoFrame::Format_YUYV) {
        const uchar *yuyv_data = clone.bits();
        int width = clone.width();
        int height = clone.height();
        int bytesPerLine = clone.bytesPerLine();

        // ‰∏∫ RGB ÂõæÂÉèÂàÜÈÖçÂÜÖÂ≠ò„ÄÇ‰ΩøÁî® QImage::Format_RGB32 Êù•ÁÆÄÂåñÂ§ÑÁêÜ
        // ÊàñËÄÖ‰ΩøÁî® QImage::Format_RGB888 Â¶ÇÊûú‰Ω†ÊÉ≥ËäÇÁúÅÂÜÖÂ≠ò
        img = QImage(width, height, QImage::Format_RGB32);

        for (int y = 0; y < height; ++y) {
            const uchar *line_ptr = yuyv_data + y * bytesPerLine;
            QRgb *rgb_line_ptr = (QRgb *)img.scanLine(y);

            for (int x = 0; x < width; x += 2) {
                // YUYV Ê†ºÂºè: Y0 U0 Y1 V0 ...
                // ÊØè‰∏™ÂÆèÂÉèÁ¥†ÂåÖÂê´ Y0, U, Y1, V
                int y0 = line_ptr[x * 2];
                int u  = line_ptr[x * 2 + 1];
                int y1 = line_ptr[x * 2 + 2];
                int v  = line_ptr[x * 2 + 3];

                // YUV to RGB ËΩ¨Êç¢ÂÖ¨Âºè (BT.601 Ê†áÂáÜÔºåÂ∏∏ËßÅ‰∫éÊëÑÂÉèÂ§¥)
                // Ë∞ÉÊï¥‰∫ÆÂ∫¶ÂÅèÁßª
                y0 = y0 - 16;
                y1 = y1 - 16;
                u  = u  - 128;
                v  = v  - 128;

                // ËÆ°ÁÆóÁ¨¨‰∏Ä‰∏™ÂÉèÁ¥† (Y0) ÁöÑ RGB
                int r0 = qBound(0, (298 * y0 + 409 * v + 128) >> 8, 255);
                int g0 = qBound(0, (298 * y0 - 100 * u - 208 * v + 128) >> 8, 255);
                int b0 = qBound(0, (298 * y0 + 516 * u + 128) >> 8, 255);
                rgb_line_ptr[x] = qRgb(r0, g0, b0);

                // ËÆ°ÁÆóÁ¨¨‰∫å‰∏™ÂÉèÁ¥† (Y1) ÁöÑ RGB
                int r1 = qBound(0, (298 * y1 + 409 * v + 128) >> 8, 255);
                int g1 = qBound(0, (298 * y1 - 100 * u - 208 * v + 128) >> 8, 255);
                int b1 = qBound(0, (298 * y1 + 516 * u + 128) >> 8, 255);
                rgb_line_ptr[x + 1] = qRgb(r1, g1, b1);
            }
        }
    }
    // Â¶ÇÊûúÂÉèÁ¥†Ê†ºÂºè‰∏çË¢´Áõ¥Êé•ÊîØÊåÅÔºå‰Ω†ÂèØËÉΩÈúÄË¶ÅÊ†πÊçÆÂÆûÈôÖÊÉÖÂÜµÂÆûÁé∞ËΩ¨Êç¢ÈÄªËæë
    else {
        txtLog->append(QString("onVideoFrame: ‰∏çÊîØÊåÅÁöÑÂÉèÁ¥†Ê†ºÂºè %1ÔºåÊó†Ê≥ïÁõ¥Êé•ËΩ¨Êç¢‰∏∫ QImage„ÄÇ").arg(pixelFormat));
        clone.unmap();
        return;
    }


    if (img.isNull() || img.sizeInBytes() == 0) { // Ê£ÄÊü• img ÊòØÂê¶Ë¢´ÊúâÊïàÊûÑÂª∫
        txtLog->append("onVideoFrame: ÂàõÂª∫QImageÂ§±Ë¥•ÊàñÂõæÂÉèÊï∞ÊçÆ‰∏∫Á©∫„ÄÇ");
        clone.unmap();
        return;
    }

    clone.unmap(); // Â∞ΩÊó©Ëß£Èô§Êò†Â∞ÑÔºåÈáäÊîæËµÑÊ∫ê

    // Êú¨Âú∞È¢ÑËßà
    QPixmap pixmap = QPixmap::fromImage(img);
    if (!pixmap.isNull()) {
        videoLabel_->setPixmap(pixmap.scaled(videoLabel_->size(), Qt::KeepAspectRatio));
    } else {
        txtLog->append("onVideoFrame: Êó†Ê≥ï‰ªéQImageÂàõÂª∫QPixmap„ÄÇ");
    }

    // ËøúÁ´ØÂèëÈÄÅ
    QByteArray jpeg;
    QBuffer buffer(&jpeg);
    buffer.open(QIODevice::WriteOnly);
    if (!img.save(&buffer, "JPEG", 60)) {
        txtLog->append("onVideoFrame: Êó†Ê≥ïÂ∞ÜÂõæÂÉè‰øùÂ≠ò‰∏∫JPEGÊ†ºÂºè„ÄÇ");
        return;
    }
    buffer.close();

    // Ê∑ªÂä†Èò≤Êä§Êù°‰ª∂ÔºöÂè™ÊúâÂú®ËøûÊé•‰∏îÂ∑≤Âä†ÂÖ•ÊàøÈó¥Êó∂ÊâçÂèëÈÄÅ
    if (!conn_.isConnected() || !isJoinedRoom_) {
        return; // ‰∏çÂèëÈÄÅÂ∏ßÊï∞ÊçÆ
    }

    QJsonObject j{{"roomId", currentRoom_},
                  {"sender", authenticatedUsername_},
                  {"ts",     QDateTime::currentMSecsSinceEpoch()}};
    conn_.send(MSG_VIDEO_FRAME, j, jpeg);
}

/* ---------- ËøûÊé•Áä∂ÊÄÅÂ§ÑÁêÜ ---------- */
void MainWindow::onConnected()
{
    isConnected_ = true;
    joinButton_->setEnabled(true);
    statusBar()->showMessage(QString("Â∑≤ËøûÊé•Âà∞ÊúçÂä°Âô® - Áî®Êà∑: %1").arg(authenticatedUsername_));
    chatDisplay_->append("‚úÖ Â∑≤ËøûÊé•Âà∞ÊúçÂä°Âô®");
    
    // If we have stored credentials from login dialog, send them now
    if (!authenticatedUsername_.isEmpty() && currentUserRole_ != UserRole::None) {
        // Auto-authenticate with stored credentials
        // This would be triggered from the login dialog after successful connection
    }
}

void MainWindow::onDisconnected()
{
    isConnected_ = false;
    isJoinedRoom_ = false;
    isAuthenticated_ = false;
    currentRoom_.clear();
    sessionToken_.clear();
    
    joinButton_->setEnabled(false);
    statusBar()->showMessage("‰∏éÊúçÂä°Âô®Êñ≠ÂºÄËøûÊé•");
    chatDisplay_->append("‚ùå ‰∏éÊúçÂä°Âô®Êñ≠ÂºÄËøûÊé•");
}

/* ---------- Ëá™Âä®ÂêØÂä®ÂäüËÉΩ ---------- */
void MainWindow::onAutoStartToggled(bool checked)
{
    saveAutoStartPreference(checked);
}

void MainWindow::tryAutoStartCamera()
{
    // Ê£ÄÊü•ÊòØÂê¶ÂêØÁî®Ëá™Âä®ÂêØÂä®Ôºå‰∏îÂΩìÂâçÊ≤°ÊúâÊëÑÂÉèÂ§¥Ê≠£Âú®ËøêË°å
    if (!chkAutoStart_->isChecked() || camera_) {
        return;
    }
    
    // Ê£ÄÊü•ÊòØÂê¶Êª°Ë∂≥ÂêØÂä®Êù°‰ª∂ÔºöÂ∑≤ËøûÊé•‰∏îÂ∑≤Âä†ÂÖ•ÊàøÈó¥
    if (!isConnected_ || !isJoinedRoom_) {
        return;
    }
    
    // Â∞ùËØïÂêØÂä®ÊëÑÂÉèÂ§¥
    const QList<QCameraInfo> cameras = QCameraInfo::availableCameras();
    if (cameras.isEmpty()) {
        QMessageBox::information(this, "Camera Not Found", 
            "No camera device found. Please:\n"
            "‚Ä¢ Install qtmultimedia and gstreamer packages\n"
            "‚Ä¢ If running in VM, pass through webcam device\n"
            "‚Ä¢ Check camera permissions");
        return;
    }
    
    startCamera();
}

void MainWindow::saveAutoStartPreference(bool enabled)
{
    settings_.setValue("autoStartCamera", enabled);
}

bool MainWindow::loadAutoStartPreference()
{
    return settings_.value("autoStartCamera", true).toBool(); // ÈªòËÆ§ÂêØÁî®
}

/* ---------- ÁôªÂΩï/Ê≥®ÂÜåÂäüËÉΩ ---------- */
void MainWindow::onLoginSuccess(const QString& username, const QString& password, UserRole role)
{
    if (!isConnected_) {
        // Auto-connect to server first
        conn_.connectTo("127.0.0.1", 9000);
        // Store credentials to send after connection
        authenticatedUsername_ = username;
        currentUserRole_ = role;
        return;
    }
    
    QString roleStr = (role == UserRole::Expert) ? "expert" : "factory";
    QJsonObject loginData{
        {"username", username}, 
        {"password", password},
        {"role", roleStr}
    };
    
    conn_.send(MSG_LOGIN, loginData);
    chatDisplay_->append(QString("Ê≠£Âú®ÁôªÂΩï: %1 (%2)").arg(username).arg(roleStr == "expert" ? "ÊäÄÊúØ‰∏ìÂÆ∂" : "Â∑•ÂéÇÁî®Êà∑"));
}

void MainWindow::onRegisterSuccess(const QString& username, const QString& password, UserRole role)
{
    if (!isConnected_) {
        // Auto-connect to server first
        conn_.connectTo("127.0.0.1", 9000);
        // Store credentials to send after connection
        authenticatedUsername_ = username;
        currentUserRole_ = role;
        return;
    }
    
    QString roleStr = (role == UserRole::Expert) ? "expert" : "factory";
    QJsonObject registerData{
        {"username", username}, 
        {"password", password},
        {"role", roleStr}
    };
    
    conn_.send(MSG_REGISTER, registerData);
    chatDisplay_->append(QString("Ê≠£Âú®Ê≥®ÂÜå: %1 (%2)").arg(username).arg(roleStr == "expert" ? "ÊäÄÊúØ‰∏ìÂÆ∂" : "Â∑•ÂéÇÁî®Êà∑"));
}
